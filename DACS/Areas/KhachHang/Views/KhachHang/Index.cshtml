
@model DACS.Models.ViewModels.KhachHangDashboardViewModel
@using Microsoft.AspNetCore.Identity
@inject UserManager<ApplicationUser> UserManager
@{
    ViewData["Title"] = "Tổng quan tài khoản";
    // Layout = "~/Areas/KhachHang/Views/Shared/_UserAccountLayout.cshtml";
    var currentUser = await UserManager.GetUserAsync(User); // Lấy user để hiển thị tên nếu cần
    var displayName = Model?.TenNguoiMua ?? currentUser?.FullName ?? User.Identity?.Name ?? "Khách";
}

@* Container và Row bao ngoài *@
<div class="container account-section">
    <div class="row">
        @* Cột Menu bên trái *@
        <div class="col-lg-3">
            <div class="account-menu list-group">
                @* Đặt class active cho link này *@
                <a asp-area="KhachHang" asp-controller="KhachHang" asp-action="Index" class="list-group-item list-group-item-action active"><i class="fas fa-tachometer-alt fa-fw me-2"></i> Tổng quan</a>
                <a asp-area="KhachHang" asp-controller="KhachHang" asp-action="HoSoCaNhan" class="list-group-item list-group-item-action "><i class="fas fa-user-circle fa-fw me-2"></i> Hồ sơ cá nhân</a>
                <a asp-area="KhachHang" asp-controller="KhachHang" asp-action="LichSuDonHang" class="list-group-item list-group-item-action"><i class="fas fa-receipt fa-fw me-2"></i> Lịch sử Đơn hàng</a>
                <a asp-area="KhachHang" asp-controller="KhachHang" asp-action="LichSuGiaoDich" class="list-group-item list-group-item-action"><i class="fas fa-credit-card fa-fw me-2"></i> Lịch sử Giao dịch</a>
                <a asp-area="Identity" asp-page="/Account/Manage/ChangePassword" class="list-group-item list-group-item-action"><i class="fas fa-lock fa-fw me-2"></i> Đổi mật khẩu</a>
                @* <a asp-area="KhachHang" asp-controller="Address" asp-action="Index" class="list-group-item list-group-item-action"><i class="fas fa-map-marker-alt fa-fw me-2"></i> Sổ địa chỉ</a> *@
                <form asp-area="Identity" asp-page="/Account/Logout" asp-route-returnUrl="@Url.Action("Index", "Home", new { area = "" })" method="post" id="logoutForm_sidebar_index">
                    <button type="submit" class="list-group-item list-group-item-action text-danger mt-3 border-0 bg-transparent"><i class="fas fa-sign-out-alt fa-fw me-2"></i> Đăng xuất</button>
                </form>
            </div>
        </div>

        @* Cột Nội dung chính bên phải *@
        <div class="col-lg-9">
            <div class="account-content">

                <h4 class="mb-4">Xin chào, @displayName!</h4>
                <p>Từ trang tổng quan tài khoản, bạn có thể xem các đơn hàng gần đây, quản lý địa chỉ giao hàng và chỉnh sửa mật khẩu cùng thông tin tài khoản.</p>

                <div class="row mt-4">
                    @* Card Đơn hàng gần đây *@
                    <div class="col-md-6">
                        <div class="card dashboard-card">
                            <div class="card-header">
                                <i class="fas fa-receipt me-2"></i> Đơn hàng gần đây
                            </div>
                            <ul class="list-group list-group-flush">
                                @if (Model?.RecentOrders != null && Model.RecentOrders.Any())
                                {
                                    @foreach (var order in Model.RecentOrders)
                                    {
                                        <li class="list-group-item d-flex justify-content-between align-items-center">
                                            <div>
                                                @* Thay đổi asp-route-id nếu cần trỏ đến chi tiết đơn hàng *@
                                                <a asp-action="OrderDetails" asp-controller="Order" asp-route-id="@order.OrderId" class="order-id-link">#@order.OrderId</a>
                                                <small class="d-block text-muted">@order.OrderDate.ToString("dd/MM/yyyy")</small>
                                            </div>
                                            @* Hiển thị Status với màu phù hợp *@
                                            <span class="badge @GetStatusBadgeClass(order.Status) order-status">@order.Status</span>
                                        </li>
                                    }
                                }
                                else
                                {
                                    <li class="list-group-item text-muted">Bạn chưa có đơn hàng nào gần đây.</li>
                                }
                                <li class="list-group-item text-center">
                                    @* Link đến trang lịch sử đơn hàng *@
                                    <a asp-action="LichSuDonHang" asp-controller="KhachHang" asp-area="KhachHang" class="btn btn-sm btn-outline-primary">Xem tất cả đơn hàng</a>
                                </li>
                            </ul>
                        </div>
                    </div>

                    @* Card Thông tin tài khoản và Địa chỉ *@
                    <div class="col-md-6">
                        <div class="card dashboard-card">
                            <div class="card-header">
                                <i class="fas fa-user-edit me-2"></i> Thông tin tài khoản
                            </div>
                            <div class="card-body">
                                <p><strong>Họ tên:</strong> @(Model?.TenNguoiMua ?? "-")</p>
                                <p><strong>Email:</strong> @(Model?.EmailNguoiMua ?? User.Identity?.Name ?? "-")</p>
                                <p><strong>SĐT:</strong> @(Model?.SdtNguoiMua ?? "-")</p>
                                @* Link đến trang sửa hồ sơ *@
                                <a asp-action="HoSoCaNhan" asp-controller="KhachHang" asp-area="KhachHang" class="btn btn-sm btn-primary"><i class="fas fa-edit me-1"></i> Quản lý hồ sơ</a>
                                @* Link đến trang đổi mật khẩu *@
                                <a asp-area="Identity" asp-page="/Account/Manage/ChangePassword" class="btn btn-sm btn-outline-secondary ms-2"><i class="fas fa-key me-1"></i> Đổi mật khẩu</a>
                            </div>
                        </div>
                        <div class="card dashboard-card">
                            <div class="card-header">
                                <i class="fas fa-map-marked-alt me-2"></i> Địa chỉ giao hàng mặc định
                            </div>
                            <div class="card-body">
                                <p>@(Model?.DiaChiMacDinh ?? "Chưa có địa chỉ mặc định.")</p>
                                @* Link đến trang quản lý địa chỉ (nếu có) *@
                                @* <a asp-action="Index" asp-controller="Address" asp-area="KhachHang" class="btn btn-sm btn-outline-primary"><i class="fas fa-address-book me-1"></i> Quản lý địa chỉ</a> *@
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>
</div>


@* Hàm C# nội tuyến để lấy class Badge màu mè cho Status (Tùy chọn) *@
@functions {
    string GetStatusBadgeClass(string status)
    {
        status = status?.ToLower() ?? "";
        if (status.Contains("đang giao") || status.Contains("shipping")) return "bg-primary";
        if (status.Contains("đã giao") || status.Contains("delivered")) return "bg-success";
        if (status.Contains("đang xử lý") || status.Contains("processing")) return "bg-info text-dark";
        if (status.Contains("đã hủy") || status.Contains("cancelled")) return "bg-danger";
        if (status.Contains("chờ thanh toán") || status.Contains("pending payment")) return "bg-warning text-dark";
        return "bg-secondary"; // Mặc định
    }
}